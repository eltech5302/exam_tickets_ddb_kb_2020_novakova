# Вопрос 18: Создание и модификация БД. Просмотр свойств БД. Создание файловых групп. «Сжатие» (Shrinking) файлов БД. Организация хранения данных. Страницы и экстенты. Способы повышения производительности сервера.

## Файлы базы данных
SQL Server имеют три типа файлов.

```Первичная``` - Первичный файл данных содержит сведения, необходимые для запуска базы данных, и ссылки на другие файлы в базе данных. Данные и объекты пользователя могут храниться в данном файле или во вторичном файле данных. В каждой базе данных имеется один первичный файл данных. Для имени первичного файла данных рекомендуется расширение MDF.

```Вторичная``` - Вторичные файлы данных не являются обязательными; это пользовательские файлы, в которых хранятся данные пользователя. Вторичные файлы могут быть использованы для распределения данных на несколько дисков, в этом случае каждый файл записывается на отдельный диск. Кроме того, если размер базы данных превышает максимальный размер для одного файла Windows, можно использовать вторичные файлы данных, таким образом база данных сможет расти дальше. Для имени вторичного файла данных рекомендуется расширение NDF.

```Журнал транзакций``` - Файлы журнала транзакций содержат сведения, используемые для восстановления базы данных. Для каждой базы данных должен существовать хотя бы один файл журнала. Для файлов журнала транзакций рекомендуется расширение LDF.

## Создание БД
```sql
CREATE DATABASE database_name
[ CONTAINMENT = { NONE | PARTIAL } ]
[ ON
      [ PRIMARY ] <filespec> [ ,...n ]
      [ , <filegroup> [ ,...n ] ]
      [ LOG ON <filespec> [ ,...n ] ]
]
[ COLLATE collation_name ]
[ WITH <option> [,...n ] ]
[;]

<option> ::=
{
      FILESTREAM ( <filestream_option> [,...n ] )
    | DEFAULT_FULLTEXT_LANGUAGE = { lcid | language_name | language_alias }
    | DEFAULT_LANGUAGE = { lcid | language_name | language_alias }
    | NESTED_TRIGGERS = { OFF | ON }
    | TRANSFORM_NOISE_WORDS = { OFF | ON}
    | TWO_DIGIT_YEAR_CUTOFF = <two_digit_year_cutoff>
    | DB_CHAINING { OFF | ON }
    | TRUSTWORTHY { OFF | ON }
    | PERSISTENT_LOG_BUFFER=ON ( DIRECTORY_NAME='<Filepath to folder on DAX formatted volume>' )
}

<filestream_option> ::=
{
      NON_TRANSACTED_ACCESS = { OFF | READ_ONLY | FULL }
    | DIRECTORY_NAME = 'directory_name'
}

<filespec> ::=
{
(
    NAME = logical_file_name ,
    FILENAME = { 'os_file_name' | 'filestream_path' }
    [ , SIZE = size [ KB | MB | GB | TB ] ]
    [ , MAXSIZE = { max_size [ KB | MB | GB | TB ] | UNLIMITED } ]
    [ , FILEGROWTH = growth_increment [ KB | MB | GB | TB | % ] ]
)
}

<filegroup> ::=
{
FILEGROUP filegroup name [ [ CONTAINS FILESTREAM ] [ DEFAULT ] | CONTAINS MEMORY_OPTIMIZED_DATA ]
    <filespec> [ ,...n ]
}
```

## Пример создания БД (лаб6)
```sql
CREATE DATABASE AW_Marketing
    ON PRIMARY
    (
        NAME = 'AW_Marketing_Data1',
        FILENAME = '/var/opt/mssql/data/AW_Marketing_Data1.mdf',
        SIZE = 10 MB,
        FILEGROWTH = 0
    ),
    FILEGROUP CurrentData
    (
        NAME = 'AW_Marketing_Data2',
        FILENAME = '/var/opt/mssql/data/AW_Marketing_Data2.ndf',
        SIZE = 10 MB,
        FILEGROWTH = 0
    ),
    FILEGROUP ArchivedData
    (
        NAME = 'AW_Marketing_Data3',
        FILENAME = '/var/opt/mssql/data/AW_Marketing_Data3.ndf',
        SIZE = 25 MB,
        FILEGROWTH = 0
    )
    LOG ON
    (
        NAME = 'AW_Marketing_log',
        FILENAME = '/var/opt/mssql/log/AW_Marketing_log.ldf',
        SIZE = 10 MB,
        FILEGROWTH = 0
    )
go
```

## Описание параметров
---

```database_name``` — имя новой базы данных. Имена баз данных должны быть уникальны внутри экземпляра SQL Server и должны соответствовать правилам для идентификаторов.

---

```CONTAINMENT``` - указывает состояние включения базы данных. 
> ```NONE``` = неавтономная база данных.

> ```PARTIAL``` = частично автономная база данных.

---

```ON``` - Указывает, что дисковые файлы, используемые для хранения разделов данных в базе данных, файлов данных, определяются явно. Параметр ```ON``` необходимо применять, если за ним следует список элементов ```<filespec>``` с разделителями-запятыми, которые определяют файлы данных первичной файловой группы. За списком файлов в первичной файловой группе может следовать необязательный список элементов ```<filegroup>``` с разделителями-запятыми, которые определяют файловые группы пользователей и принадлежащие им файлы.
> ```PRIMARY``` - указывает, что связанный список ```<filespec>``` определяет первичный файл. Первый файл, указанный в элементе ```<filespec>``` в первичной файловой группе, становится первичным файлом. В базе данных может быть только один первичный файл. Если параметр ```PRIMARY``` не указан, то первый файл списка в инструкции CREATE DATABASE становится первичным файлом.

> ```LOG ON``` - указывает, что дисковые файлы, используемые для хранения журнала базы данных, то есть файлы журналов, определяются явно. За параметром ```LOG ON``` следует список элементов ```<filespec>``` с разделителями-запятыми, которые определяют файлы журналов. Если параметр ```LOG ON``` не указан, автоматически создается один файл журнала, размер которого определяется большей из следующих двух величин: 512 КБ или 25 процентов от суммы размеров всех файлов данных в базе данных. Этот файл помещается в местоположение для журнала по умолчанию. Параметр ```LOG ON``` не может указываться для моментального снимка базы данных.

---

```COLLATE``` collation_name - задает параметры сортировки по умолчанию для базы данных. Именем параметров сортировки может быть либо имя параметров сортировки Windows, либо имя параметров сортировки SQL. Если параметр не указан, базе данных назначаются параметры сортировки по умолчанию для экземпляра SQL Server. Имя параметров сортировки не может указываться для моментального снимка базы данных.

---

```<filestream_options>```

NON_TRANSACTED_ACCESS = { OFF | READ_ONLY | FULL } - указывает уровень нетранзакционного доступа FILESTREAM к базе данных.
> ```OFF``` - Нетранзакционный доступ отключен.

> ```READONLY``` - Данные FILESTREAM в этой базе данных могут быть считаны нетранзакционными процессами.

> ```FULL``` - Полный нетранзакционный доступ к FILESTREAM FileTable включен.

```DIRECTORY_NAME = <directory_name>``` - Имя каталога, совместимое с Windows. Это имя должно быть уникально среди всех имен Database_Directory в экземпляре SQL Server. Проверка уникальности выполняется с учетом регистра, независимо от параметров сортировки SQL Server. Этот параметр необходимо назначить до создания FileTable в этой базе данных.

Следующие параметры разрешаются, только если параметр ```CONTAINMENT``` установлен в состояние ```PARTIAL```. Если параметр ```CONTAINMENT``` установлен в состояние ```NONE```, возникнут ошибки.

---

